<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NutriGuard AI</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>

  <!-- Right-side language selector -->
  <div class="lang-picker" id="langPicker" aria-label="Language picker">
    <button id="langBtn" title="Choose language" aria-haspopup="true" aria-expanded="false">
      <span class="lang-flag" id="langFlag">ğŸŒ</span>
      <span id="currentLang" class="lang-code">EN</span>
      <svg class="chev" width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden>
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="lang-menu" id="langMenu" role="menu" hidden>
      <button class="lang-option" data-lang="en" role="menuitem">EN â€” English</button>
      <button class="lang-option" data-lang="hi" role="menuitem">HI â€” à¤¹à¤¿à¤¨à¥à¤¦à¥€</button>
      <button class="lang-option" data-lang="te" role="menuitem">TE â€” à°¤à±†à°²à±à°—à±</button>
    </div>
  </div>

  <div class="container">
    <div class="input-section" role="region" aria-labelledby="title">
      <h2 id="title">ğŸ¥— NutriGuard AI â€” Smart Nutrition Recommender</h2>

      <div class="user-inputs">
        <input type="number" id="height" placeholder="Height (cm)" aria-label="Height">
        <input type="number" id="weight" placeholder="Weight (kg)" aria-label="Weight">
        <select id="gender" aria-label="Gender">
          <option value="Male">Male â™‚ï¸</option>
          <option value="Female">Female â™€ï¸</option>
        </select>
        <input type="text" id="city" placeholder="Enter your city" aria-label="City">
        <p class="small" id="qtyTip">Tip: Qty is interpreted as <strong>grams</strong> (e.g. 200 for 200g).</p>
      </div>

      <div id="food-list">
        <div class="food-item">
          <input type="text" placeholder="Food name" class="food-name" />
          <input type="number" placeholder="Qty (g)" class="food-qty" min="1" value="100" />
        </div>
      </div>

      <div class="controls">
        <button id="addBtn">â• Add Another Food</button>
        <button id="analyzeBtn">Analyze ğŸ½ï¸</button>
        <a href="/smart_gross_list" class="button">ğŸ›’ Smart Grocery List</a>
      </div>
    </div>

    <div id="output" class="output-section" aria-live="polite"></div>
  </div>

  <!-- Simple Chat Widget -->
  <div id="chat-widget" style="position: fixed; right: 20px; bottom: 20px; width: 350px; height: 500px; background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; z-index: 1000; border: 1px solid #e0e0e0;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; font-size: 16px;">ğŸ¤– AI Dietician Assistant</h3>
      <button id="chat-toggle" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">âˆ’</button>
    </div>
    <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa;">
      <div style="margin-bottom: 10px; padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.4; background: white; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px;">
        ğŸ‘‹ Hello! I'm your AI Dietician. Analyze your nutrition first, then I can give you personalized advice!
      </div>
    </div>
    <div style="display: flex; padding: 15px; border-top: 1px solid #e0e0e0; background: white;">
      <input type="text" id="chat-input" placeholder="Ask about nutrition..." style="flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; font-size: 14px;">
      <button id="chat-send" style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 25px; margin-left: 10px; cursor: pointer; font-size: 14px;">Send</button>
    </div>
    <div style="display: flex; padding: 10px; background: #f8f9fa; border-top: 1px solid #e0e0e0; gap: 5px; flex-wrap: wrap;">
      <button class="suggestion-btn" data-prompt="What should I eat for breakfast?" style="background: #e9ecef; border: 1px solid #dee2e6; border-radius: 15px; padding: 8px 12px; font-size: 12px; cursor: pointer; flex: 1; min-width: 80px; text-align: center;">ğŸ³ Breakfast</button>
      <button class="suggestion-btn" data-prompt="Suggest a meal plan" style="background: #e9ecef; border: 1px solid #dee2e6; border-radius: 15px; padding: 8px 12px; font-size: 12px; cursor: pointer; flex: 1; min-width: 80px; text-align: center;">ğŸ“‹ Meal Plan</button>
      <button class="suggestion-btn" data-prompt="How to improve protein intake?" style="background: #e9ecef; border: 1px solid #dee2e6; border-radius: 15px; padding: 8px 12px; font-size: 12px; cursor: pointer; flex: 1; min-width: 80px; text-align: center;">ğŸ’ª Protein</button>
    </div>
  </div>

<script>
// Simple Chat Functionality
function addChatMessage(text, sender) {
  const chatMessages = document.getElementById("chat-messages");
  if (!chatMessages) {
    console.log('Chat messages not found');
    return;
  }
  
  const messageDiv = document.createElement("div");
  messageDiv.style.marginBottom = '10px';
  messageDiv.style.padding = '10px 15px';
  messageDiv.style.borderRadius = '18px';
  messageDiv.style.maxWidth = '80%';
  messageDiv.style.lineHeight = '1.4';
  messageDiv.style.wordWrap = 'break-word';
  
  if (sender === 'user') {
    messageDiv.style.background = '#007bff';
    messageDiv.style.color = 'white';
    messageDiv.style.marginLeft = 'auto';
    messageDiv.style.borderBottomRightRadius = '4px';
  } else {
    messageDiv.style.background = 'white';
    messageDiv.style.color = '#333';
    messageDiv.style.border = '1px solid #e0e0e0';
    messageDiv.style.borderBottomLeftRadius = '4px';
  }
  
  messageDiv.textContent = text;
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return messageDiv;
}

async function sendChatMessage(message) {
  if (!message.trim()) return;

  // Add user message
  addChatMessage(message, 'user');
  
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  
  if (chatInput) chatInput.value = '';
  if (chatSend) chatSend.disabled = true;

  // Show typing indicator
  const typingIndicator = addChatMessage('AI is typing...', 'ai');
  if (typingIndicator) {
    typingIndicator.style.fontStyle = 'italic';
    typingIndicator.style.color = '#666';
  }

  try {
    const response = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: message,
        lang: 'en'
      })
    });

    const data = await response.json();
    
    // Remove typing indicator
    if (typingIndicator) typingIndicator.remove();
    
    // Add AI response
    if (data.response) {
      addChatMessage(data.response, 'ai');
    } else if (data.reply) {
      addChatMessage(data.reply, 'ai');
    } else {
      addChatMessage('Sorry, I could not process your request.', 'ai');
    }
  } catch (error) {
    if (typingIndicator) typingIndicator.remove();
    addChatMessage('Error connecting to AI service.', 'ai');
    console.error('Chat error:', error);
  } finally {
    if (chatSend) chatSend.disabled = false;
    if (chatInput) chatInput.focus();
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('Page loaded, initializing chat...');
  
  // Chat elements
  const chatWidget = document.getElementById("chat-widget");
  const chatToggle = document.getElementById("chat-toggle");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");
  const suggestionBtns = document.querySelectorAll('.suggestion-btn');

  console.log('Chat widget:', chatWidget);
  console.log('Chat toggle:', chatToggle);
  console.log('Chat input:', chatInput);
  console.log('Chat send:', chatSend);
  console.log('Suggestion buttons:', suggestionBtns.length);

  if (!chatWidget) {
    console.error('âŒ Chat widget not found!');
    return;
  }

  console.log('âœ… Chat widget found! Setting up listeners...');

  // Toggle chat
  if (chatToggle) {
    chatToggle.addEventListener('click', function() {
      if (chatWidget.style.height === '60px') {
        chatWidget.style.height = '500px';
        chatToggle.textContent = 'âˆ’';
      } else {
        chatWidget.style.height = '60px';
        chatToggle.textContent = '+';
      }
    });
  }

  // Send message
  if (chatSend && chatInput) {
    chatSend.addEventListener('click', function() {
      sendChatMessage(chatInput.value);
    });
    
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendChatMessage(chatInput.value);
      }
    });
  }

  // Suggestion buttons
  suggestionBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const prompt = this.getAttribute('data-prompt');
      sendChatMessage(prompt);
    });
  });

  console.log('âœ… Chat initialized successfully!');
});

// Basic app functionality
function addFood() {
  const list = document.getElementById("food-list");
  const div = document.createElement("div");
  div.className = "food-item";
  div.innerHTML = `
    <input type="text" placeholder="Food name" class="food-name" />
    <input type="number" placeholder="Qty (g)" class="food-qty" min="1" value="100" />
  `;
  list.appendChild(div);
}

async function analyze() {
  const city = document.getElementById("city").value.trim();
  const gender = document.getElementById("gender").value;
  const height = document.getElementById("height").value;
  const weight = document.getElementById("weight").value;
  const foodNames = document.querySelectorAll(".food-name");
  const foodQtys = document.querySelectorAll(".food-qty");

  const items = [];
  for (let i = 0; i < foodNames.length; i++) {
    const name = foodNames[i].value.trim();
    const qty = foodQtys[i].value;
    if (name) items.push({ name, qty });
  }

  const payload = { city, gender, height, weight, items, lang: 'en' };
  const outEl = document.getElementById("output");
  outEl.innerHTML = `<p>â³ Analyzing...</p>`;

  try {
    const res = await fetch("/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.error) {
      outEl.innerHTML = `<p style="color:red;">âŒ ${data.error}</p>`;
      return;
    }
    
    // Display results
    let html = `<h3>âœ… Weather in ${city}</h3>`;
    html += `<p>ğŸŒ¤ ${data.weather.condition}, ğŸŒ¡ ${data.weather.temp}Â°C, ğŸ’§ ${data.weather.humidity}%</p>`;
    
    html += `<h3>ğŸ“Š Total Nutrients:</h3><ul>`;
    for (const [k, v] of Object.entries(data.total_nutrients)) {
      html += `<li><strong>${k}:</strong> ${v}</li>`;
    }
    html += `</ul>`;
    
    html += `<h3>ğŸ§© Deficient Nutrients:</h3><ul>`;
    for (const [k, v] of Object.entries(data.deficient)) {
      html += `<li><strong>${k}:</strong> need ${v} more</li>`;
    }
    html += `</ul>`;
    
    html += `<h3>ğŸ´ Recommendations:</h3><ul>`;
    data.recommendations.forEach(item => {
      html += `<li>${item[0]} â€” ${item[1]}</li>`;
    });
    html += `</ul>`;
    
    outEl.innerHTML = html;
    
    // Enable chat with analysis data
    addChatMessage("I can see your nutrition analysis! Ask me anything about your deficiencies.", 'ai');
    
  } catch (err) {
    outEl.innerHTML = `<p style="color:red;">âŒ ${err.message}</p>`;
  }
}

// Wire up buttons
document.getElementById("addBtn").addEventListener("click", addFood);
document.getElementById("analyzeBtn").addEventListener("click", analyze);

console.log('ï¿½ï¿½ NutriGuard AI loaded successfully!');
</script>

</body>
</html>
